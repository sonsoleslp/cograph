# Tests for CographNetwork R6 class
# Covers: R/class-network.R

test_that("CographNetwork can be created from matrix", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  expect_s3_class(net, "CographNetwork")
  expect_equal(net$n_nodes, 4)
})

test_that("CographNetwork can be created empty", {
  net <- CographNetwork$new()

  expect_s3_class(net, "CographNetwork")
})

test_that("CographNetwork respects directed parameter", {
  mat <- create_test_matrix(4, symmetric = FALSE)

  net_directed <- CographNetwork$new(mat, directed = TRUE)
  expect_true(net_directed$is_directed)

  net_undirected <- CographNetwork$new(mat, directed = FALSE)
  expect_false(net_undirected$is_directed)
})

test_that("CographNetwork respects node_labels parameter", {
  mat <- create_test_matrix(4)
  labels <- c("A", "B", "C", "D")

  net <- CographNetwork$new(mat, node_labels = labels)

  result_labels <- net$get_labels()
  expect_equal(result_labels, labels)
})

test_that("CographNetwork validates node_labels length", {
  mat <- create_test_matrix(4)

  expect_error(
    CographNetwork$new(mat, node_labels = c("A", "B")),
    "must match"
  )
})

test_that("CographNetwork n_nodes property works", {
  mat <- create_test_matrix(5)
  net <- CographNetwork$new(mat)

  expect_equal(net$n_nodes, 5)
})

test_that("CographNetwork n_edges property works", {
  mat <- create_test_topology("complete", 4)
  net <- CographNetwork$new(mat)

  # Complete graph of 4 nodes has 6 edges (undirected)
  expect_true(net$n_edges > 0)
})

test_that("CographNetwork is_directed property works", {
  mat <- create_test_matrix(4, symmetric = FALSE)

  net <- CographNetwork$new(mat, directed = TRUE)
  expect_true(net$is_directed)
})

test_that("CographNetwork clone_network creates independent copy", {
  mat <- create_test_matrix(4)
  net1 <- CographNetwork$new(mat)
  net2 <- net1$clone_network()

  expect_s3_class(net2, "CographNetwork")
  expect_equal(net2$n_nodes, net1$n_nodes)
})

test_that("CographNetwork set_nodes works", {
  net <- CographNetwork$new()
  nodes_df <- data.frame(id = 1:3, label = c("A", "B", "C"))

  net$set_nodes(nodes_df)

  expect_equal(net$n_nodes, 3)
})

test_that("CographNetwork set_edges works", {
  net <- CographNetwork$new()
  edges_df <- data.frame(from = c(1, 2), to = c(2, 3), weight = c(1, 1))

  net$set_edges(edges_df)

  # Should have edges
  expect_true(is.data.frame(net$get_edges()) || net$n_edges >= 0)
})

test_that("CographNetwork set_directed works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat, directed = FALSE)

  net$set_directed(TRUE)
  expect_true(net$is_directed)

  net$set_directed(FALSE)
  expect_false(net$is_directed)
})

test_that("CographNetwork set_weights works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  weights <- c(1, 2, 3, 4)
  net$set_weights(weights)

  result <- net$get_weights()
  # Should have weights set
  expect_true(!is.null(result) || length(result) >= 0)
})

test_that("CographNetwork set_layout_coords with matrix works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  coords <- matrix(c(0, 1, 0, 1, 0, 0, 1, 1), ncol = 2)
  net$set_layout_coords(coords)

  layout <- net$get_layout()
  expect_equal(nrow(layout), 4)
})

test_that("CographNetwork set_layout_coords with data.frame works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  coords <- data.frame(x = c(0, 1, 0, 1), y = c(0, 0, 1, 1))
  net$set_layout_coords(coords)

  layout <- net$get_layout()
  expect_equal(nrow(layout), 4)
})

test_that("CographNetwork set_node_aes works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  net$set_node_aes(list(fill = "red", size = 0.1))

  aes <- net$get_node_aes()
  expect_equal(aes$fill, "red")
  expect_equal(aes$size, 0.1)
})

test_that("CographNetwork set_edge_aes works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  net$set_edge_aes(list(color = "blue", width = 2))

  aes <- net$get_edge_aes()
  expect_equal(aes$color, "blue")
  expect_equal(aes$width, 2)
})

test_that("CographNetwork set_theme works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  theme <- list(background = "white", node_fill = "steelblue")
  net$set_theme(theme)

  result <- net$get_theme()
  expect_true(is.list(result))
})

test_that("CographNetwork set_layout_info works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  info <- list(type = "circle", seed = 42)
  net$set_layout_info(info)

  result <- net$get_layout_info()
  expect_equal(result$type, "circle")
})

test_that("CographNetwork set_plot_params works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  params <- list(title = "Test", margins = c(0.1, 0.1, 0.1, 0.1))
  net$set_plot_params(params)

  result <- net$get_plot_params()
  expect_equal(result$title, "Test")
})

test_that("CographNetwork get_nodes returns data frame", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  nodes <- net$get_nodes()

  expect_true(is.data.frame(nodes))
  expect_equal(nrow(nodes), 4)
})

test_that("CographNetwork get_edges returns data frame", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  edges <- net$get_edges()

  expect_true(is.data.frame(edges))
})

test_that("CographNetwork get_labels returns character vector", {
  mat <- create_test_matrix(4)
  rownames(mat) <- colnames(mat) <- c("A", "B", "C", "D")
  net <- CographNetwork$new(mat)

  labels <- net$get_labels()

  expect_true(is.character(labels))
  expect_equal(length(labels), 4)
})

test_that("CographNetwork get_weights returns numeric", {
  mat <- create_test_matrix(4, weighted = TRUE)
  net <- CographNetwork$new(mat)

  weights <- net$get_weights()

  expect_true(is.numeric(weights) || is.null(weights))
})

test_that("CographNetwork get_layout returns data frame with x,y", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  # Compute layout first
  coords <- data.frame(x = runif(4), y = runif(4))
  net$set_layout_coords(coords)

  layout <- net$get_layout()

  expect_true(is.data.frame(layout))
  expect_true("x" %in% names(layout))
  expect_true("y" %in% names(layout))
})

test_that("CographNetwork get_node_aes returns list", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  aes <- net$get_node_aes()

  expect_true(is.list(aes))
  expect_true("fill" %in% names(aes))
  expect_true("size" %in% names(aes))
})

test_that("CographNetwork get_edge_aes returns list", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  aes <- net$get_edge_aes()

  expect_true(is.list(aes))
  expect_true("color" %in% names(aes))
  expect_true("width" %in% names(aes))
})

test_that("CographNetwork computes layout correctly", {
  mat <- create_test_matrix(5)
  net <- CographNetwork$new(mat)

  net$compute_layout("circle")

  layout <- net$get_layout()
  expect_equal(nrow(layout), 5)
  expect_true(all(c("x", "y") %in% names(layout)))
})

test_that("CographNetwork apply_theme works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  net$apply_theme("classic")

  theme <- net$get_theme()
  expect_true(is.list(theme))
})

test_that("CographNetwork to_matrix returns adjacency matrix", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  result <- net$to_matrix()

  expect_true(is.matrix(result))
  expect_equal(nrow(result), 4)
  expect_equal(ncol(result), 4)
})

test_that("CographNetwork to_edgelist returns data frame", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  result <- net$to_edgelist()

  expect_true(is.data.frame(result))
  expect_true(all(c("from", "to") %in% names(result)))
})

test_that("CographNetwork handles weighted networks", {
  mat <- create_test_matrix(4, weighted = TRUE)
  net <- CographNetwork$new(mat)

  weights <- net$get_weights()
  expect_true(is.numeric(weights) || length(weights) >= 0)
})

test_that("CographNetwork handles empty network", {
  mat <- matrix(0, 4, 4)
  net <- CographNetwork$new(mat)

  expect_equal(net$n_nodes, 4)
  expect_equal(net$n_edges, 0)
})

test_that("CographNetwork handles single node", {
  mat <- matrix(0, 1, 1)
  net <- CographNetwork$new(mat)

  expect_equal(net$n_nodes, 1)
})

test_that("CographNetwork handles self loops", {
  mat <- diag(1, 4)
  net <- CographNetwork$new(mat)

  expect_equal(net$n_nodes, 4)
})

test_that("CographNetwork default aesthetics are set", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  node_aes <- net$get_node_aes()
  expect_true(!is.null(node_aes$size))
  expect_true(!is.null(node_aes$shape))
  expect_true(!is.null(node_aes$fill))

  edge_aes <- net$get_edge_aes()
  expect_true(!is.null(edge_aes$width))
  expect_true(!is.null(edge_aes$color))
})

test_that("CographNetwork print method works", {
  mat <- create_test_matrix(4)
  net <- CographNetwork$new(mat)

  # Should not error
  expect_output(print(net))
})
