# Extended tests for input converters
# Covers: R/input-qgraph.R, R/input-statnet.R, R/input-tna.R

# ============================================
# qgraph Input Tests
# ============================================

test_that("parse_qgraph errors without qgraph package", {
  skip_if_not_installed("qgraph")

  # This tests the internal function
  # Actual qgraph conversion is tested via from_qgraph
})

test_that("from_qgraph converts qgraph object", {
  skip_if_no_qgraph()

  # Create a simple qgraph object
  mat <- create_test_matrix(4)
  q <- qgraph::qgraph(mat, DoNotPlot = TRUE)

  # Convert to cograph
  net <- from_qgraph(q)

  expect_s3_class(net, "cograph_network")
  expect_equal(net$network$n_nodes, 4)
})
test_that("from_qgraph preserves layout", {
  skip_if_no_qgraph()

  mat <- create_test_matrix(4)
  q <- qgraph::qgraph(mat, DoNotPlot = TRUE)

  net <- from_qgraph(q)

  # Layout should exist
  layout <- net$network$get_layout()
  expect_false(is.null(layout))
  expect_equal(nrow(layout), 4)
})

test_that("from_qgraph handles directed parameter", {
  skip_if_no_qgraph()

  mat <- create_test_matrix(4, symmetric = FALSE)
  q <- qgraph::qgraph(mat, DoNotPlot = TRUE)

  # Force undirected
  net <- from_qgraph(q, directed = FALSE)
  expect_s3_class(net, "cograph_network")
})

test_that("from_qgraph handles weighted networks", {
  skip_if_no_qgraph()

  mat <- create_test_matrix(4, weighted = TRUE)
  q <- qgraph::qgraph(mat, DoNotPlot = TRUE)

  net <- from_qgraph(q)
  expect_s3_class(net, "cograph_network")
})

# ============================================
# statnet Input Tests (internal parse_statnet)
# ============================================

test_that("parse_statnet validates network class", {
  skip_if_not_installed("network")

  # Non-network object should error
  expect_error(
    cograph:::parse_statnet(list(a = 1)),
    "must be a network object"
  )
})

test_that("parse_statnet parses network object", {
  skip_if_not_installed("network")

  mat <- create_test_matrix(4)
  net_obj <- network::network(mat, directed = FALSE)

  result <- cograph:::parse_statnet(net_obj)

  expect_true(is.list(result))
  expect_true(!is.null(result$nodes))
  expect_true(!is.null(result$edges))
})

test_that("parse_statnet handles directed networks", {
  skip_if_not_installed("network")

  mat <- create_test_matrix(4, symmetric = FALSE)
  net_obj <- network::network(mat, directed = TRUE)

  result <- cograph:::parse_statnet(net_obj)
  expect_true(result$directed)
})

test_that("parse_statnet handles empty network", {
  skip_if_not_installed("network")

  net_obj <- network::network.initialize(4, directed = FALSE)

  result <- cograph:::parse_statnet(net_obj)
  expect_equal(nrow(result$nodes), 4)
})

# ============================================
# tna Input Tests
# ============================================

test_that("parse_tna validates tna class", {
  # Non-tna object should error
  expect_error(
    cograph:::parse_tna(list(weights = matrix(0, 3, 3))),
    "must be a tna object"
  )
})

test_that("parse_tna parses tna object", {
  # Create a mock tna object
  tna_obj <- structure(
    list(
      weights = matrix(c(0, 0.5, 0.3, 0.4, 0, 0.2, 0.3, 0.5, 0), 3, 3),
      labels = c("A", "B", "C"),
      inits = c(0.4, 0.3, 0.3)
    ),
    class = "tna"
  )

  result <- cograph:::parse_tna(tna_obj)

  expect_true(is.list(result))
  expect_true(!is.null(result$nodes))
  expect_true(!is.null(result$edges))
  expect_equal(nrow(result$nodes), 3)
})

test_that("parse_tna handles empty network", {
  tna_obj <- structure(
    list(
      weights = matrix(0, 3, 3),
      labels = c("A", "B", "C"),
      inits = NULL
    ),
    class = "tna"
  )

  result <- cograph:::parse_tna(tna_obj)
  expect_equal(nrow(result$nodes), 3)
  expect_equal(nrow(result$edges), 0)
})

test_that("parse_tna preserves inits as node attribute", {
  tna_obj <- structure(
    list(
      weights = matrix(c(0, 0.5, 0.5, 0), 2, 2),
      labels = c("X", "Y"),
      inits = c(0.6, 0.4)
    ),
    class = "tna"
  )

  result <- cograph:::parse_tna(tna_obj)

  # Should have inits column
  expect_true("inits" %in% names(result$nodes))
})

test_that("parse_tna treats networks as directed", {
  tna_obj <- structure(
    list(
      weights = matrix(c(0, 0.5, 0.3, 0), 2, 2),
      labels = c("A", "B"),
      inits = NULL
    ),
    class = "tna"
  )

  result <- cograph:::parse_tna(tna_obj)
  expect_true(result$directed)
})

test_that("parse_tna handles missing labels", {
  tna_obj <- structure(
    list(
      weights = matrix(c(0, 1, 1, 0), 2, 2),
      labels = NULL,
      inits = NULL
    ),
    class = "tna"
  )

  result <- cograph:::parse_tna(tna_obj)
  expect_equal(nrow(result$nodes), 2)
})

test_that("from_tna is exported and works", {
  skip_if_no_tna()

  # Only test if tna package is available
  tna_obj <- structure(
    list(
      weights = matrix(c(0, 0.5, 0.5, 0), 2, 2),
      labels = c("A", "B"),
      inits = NULL
    ),
    class = "tna"
  )

  # from_tna should be exported
  result <- from_tna(tna_obj)
  expect_s3_class(result, "cograph_network")
})
