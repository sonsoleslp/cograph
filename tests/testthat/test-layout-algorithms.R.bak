# Tests for layout algorithms
# Covers: R/layout-gephi-fr.R, R/layout-registry.R

# ============================================
# Gephi Fruchterman-Reingold Layout Tests
# ============================================

test_that("layout_gephi_fr returns matrix with correct dimensions", {
  skip_if_no_igraph()

  g <- igraph::make_ring(10)
  coords <- cograph:::layout_gephi_fr(g)

  expect_true(is.matrix(coords))
  expect_equal(nrow(coords), 10)
  expect_equal(ncol(coords), 2)
})

test_that("layout_gephi_fr handles empty graph", {
  skip_if_no_igraph()

  g <- igraph::make_empty_graph(0)
  coords <- cograph:::layout_gephi_fr(g)

  expect_true(is.matrix(coords))
  expect_equal(nrow(coords), 0)
  expect_equal(ncol(coords), 2)
})

test_that("layout_gephi_fr handles single node", {
  skip_if_no_igraph()

  g <- igraph::make_empty_graph(1)
  coords <- cograph:::layout_gephi_fr(g)

  expect_equal(nrow(coords), 1)
  expect_equal(ncol(coords), 2)
})

test_that("layout_gephi_fr respects area parameter", {
  skip_if_no_igraph()

  g <- igraph::make_ring(5)

  # Different area should give different spread
  coords_small <- cograph:::layout_gephi_fr(g, area = 1000, niter = 50)
  coords_large <- cograph:::layout_gephi_fr(g, area = 50000, niter = 50)

  # Both should produce valid coordinates
  expect_true(all(is.finite(coords_small)))
  expect_true(all(is.finite(coords_large)))
})

test_that("layout_gephi_fr respects gravity parameter", {
  skip_if_no_igraph()

  g <- igraph::make_ring(5)

  coords_low <- cograph:::layout_gephi_fr(g, gravity = 1, niter = 50)
  coords_high <- cograph:::layout_gephi_fr(g, gravity = 100, niter = 50)

  expect_true(all(is.finite(coords_low)))
  expect_true(all(is.finite(coords_high)))
})

test_that("layout_gephi_fr respects niter parameter", {
  skip_if_no_igraph()

  g <- igraph::make_ring(5)

  # More iterations should still produce valid coords
  coords <- cograph:::layout_gephi_fr(g, niter = 200)

  expect_true(all(is.finite(coords)))
})

test_that("compute_layout_gephi_fr works with network object", {
  skip_if_no_igraph()

  mat <- create_test_matrix(5)
  net <- cograph(mat)

  coords <- cograph:::compute_layout_gephi_fr(net$network, niter = 20)

  expect_true(is.data.frame(coords))
  expect_equal(nrow(coords), 5)
  expect_true(all(c("x", "y") %in% names(coords)))
})

# ============================================
# Layout Registry Tests
# ============================================

test_that("register_builtin_layouts registers all layouts", {
  # Should be called on package load
  layouts <- list_layouts()

  # Check for essential layouts
  expect_true("circle" %in% layouts)
  expect_true("spring" %in% layouts || "fr" %in% layouts)
  expect_true("grid" %in% layouts)
  expect_true("random" %in% layouts)
  expect_true("star" %in% layouts)
})

test_that("grid layout works", {
  mat <- create_test_matrix(9)
  net <- cograph(mat)

  result <- safe_plot(soplot(net, layout = "grid"))
  expect_true(result$success, info = result$error)
})

test_that("grid layout handles custom ncol", {
  mat <- create_test_matrix(12)
  net <- cograph(mat)

  result <- safe_plot(soplot(net, layout = "grid"))
  expect_true(result$success, info = result$error)
})

test_that("random layout works", {
  mat <- create_test_matrix(5)
  net <- cograph(mat)

  result <- safe_plot(soplot(net, layout = "random"))
  expect_true(result$success, info = result$error)
})

test_that("random layout respects seed", {
  mat <- create_test_matrix(5)
  net <- cograph(mat)

  # Same seed should give same layout
  result1 <- safe_plot(soplot(net, layout = "random", seed = 123))
  result2 <- safe_plot(soplot(net, layout = "random", seed = 123))

  expect_true(result1$success)
  expect_true(result2$success)
})

test_that("star layout works", {
  mat <- create_test_matrix(6)
  net <- cograph(mat)

  result <- safe_plot(soplot(net, layout = "star"))
  expect_true(result$success, info = result$error)
})

test_that("bipartite layout works", {
  mat <- create_test_matrix(6)
  net <- cograph(mat)

  result <- safe_plot(soplot(net, layout = "bipartite"))
  expect_true(result$success, info = result$error)
})

test_that("bipartite layout handles custom types", {
  mat <- create_test_matrix(6)
  net <- cograph(mat)

  # Types vector
  result <- safe_plot(soplot(net, layout = "bipartite"))
  expect_true(result$success, info = result$error)
})

test_that("custom layout works with matrix", {
  mat <- create_test_matrix(4)
  layout_coords <- matrix(c(0, 0, 1, 1, 0, 1, 0, 1), ncol = 2)

  result <- safe_plot(soplot(mat, layout = layout_coords))
  expect_true(result$success, info = result$error)
})

test_that("gephi_fr layout works", {
  skip_if_no_igraph()

  mat <- create_test_matrix(5)

  result <- safe_plot(soplot(mat, layout = "gephi_fr"))
  expect_true(result$success, info = result$error)
})

test_that("gephi layout alias works", {
  skip_if_no_igraph()

  mat <- create_test_matrix(5)

  result <- safe_plot(soplot(mat, layout = "gephi"))
  expect_true(result$success, info = result$error)
})

test_that("oval layout works", {
  mat <- create_test_matrix(8)

  result <- safe_plot(soplot(mat, layout = "oval"))
  expect_true(result$success, info = result$error)
})

test_that("ellipse layout alias works", {
  mat <- create_test_matrix(8)

  result <- safe_plot(soplot(mat, layout = "ellipse"))
  expect_true(result$success, info = result$error)
})

test_that("spring layout works", {
  mat <- create_test_matrix(5)

  result <- safe_plot(soplot(mat, layout = "spring"))
  expect_true(result$success, info = result$error)
})

test_that("fruchterman-reingold layout alias works", {
  mat <- create_test_matrix(5)

  result <- safe_plot(soplot(mat, layout = "fr"))
  expect_true(result$success, info = result$error)
})

test_that("groups layout works", {
  mat <- create_test_matrix(9)
  colnames(mat) <- rownames(mat) <- LETTERS[1:9]

  result <- safe_plot(soplot(mat, layout = "groups"))
  expect_true(result$success, info = result$error)
})

# ============================================
# Empty/Edge Case Layout Tests
# ============================================

test_that("layouts handle single node", {
  mat <- matrix(0, 1, 1)

  for (layout in c("circle", "grid", "random", "star")) {
    result <- safe_plot(soplot(mat, layout = layout))
    expect_true(result$success, info = paste("Layout", layout, "failed:", result$error))
  }
})

test_that("layouts handle empty graph", {
  mat <- matrix(0, 4, 4)

  for (layout in c("circle", "grid", "random", "star", "bipartite")) {
    result <- safe_plot(soplot(mat, layout = layout))
    expect_true(result$success, info = paste("Layout", layout, "failed:", result$error))
  }
})
