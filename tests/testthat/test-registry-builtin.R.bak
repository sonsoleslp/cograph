# Tests for built-in shape, theme, and layout registration
# Covers: R/shapes-registry.R, R/themes-registry.R

# ============================================
# Built-in Shapes Registry Tests
# ============================================

test_that("register_builtin_shapes registers all basic shapes", {
  shapes <- list_shapes()

  basic <- c("circle", "square", "triangle", "diamond", "pentagon", "hexagon")
  for (shape in basic) {
    expect_true(shape %in% shapes, info = paste("Missing basic shape:", shape))
  }
})

test_that("register_builtin_shapes registers special shapes", {
  shapes <- list_shapes()

  special <- c("ellipse", "heart", "star", "pie", "donut")
  for (shape in special) {
    expect_true(shape %in% shapes, info = paste("Missing special shape:", shape))
  }
})

test_that("register_builtin_shapes registers AI-themed shapes", {
  shapes <- list_shapes()

  ai_shapes <- c("neural", "chip", "robot", "brain", "network", "database", "cloud", "gear")
  for (shape in ai_shapes) {
    expect_true(shape %in% shapes, info = paste("Missing AI shape:", shape))
  }
})

test_that("register_builtin_shapes registers composite shapes", {
  shapes <- list_shapes()

  composite <- c("polygon_donut", "donut_pie", "double_donut_pie")
  for (shape in composite) {
    expect_true(shape %in% shapes, info = paste("Missing composite shape:", shape))
  }
})

test_that("cross and plus are registered (plus is alias)", {
  shapes <- list_shapes()

  expect_true("cross" %in% shapes)
  expect_true("plus" %in% shapes)
})

test_that("rectangle shape is registered", {
  shapes <- list_shapes()
  expect_true("rectangle" %in% shapes)
})

test_that("none shape is registered", {
  shapes <- list_shapes()
  expect_true("none" %in% shapes)
})

test_that("rectangle shape works in soplot", {
  mat <- create_test_matrix(3)

  result <- safe_plot(soplot(mat, node_shape = "rectangle", layout = "circle"))
  expect_true(result$success, info = result$error)
})

test_that("none shape produces no visible nodes", {
  mat <- create_test_matrix(3)

  result <- safe_plot(soplot(mat, node_shape = "none", layout = "circle"))
  expect_true(result$success, info = result$error)
})

test_that("all built-in shapes can be used in soplot", {
  mat <- create_test_matrix(3)
  shapes <- list_shapes()

  # Test a subset to keep test fast
  test_shapes <- c("circle", "square", "triangle", "diamond", "star",
                   "heart", "cross", "rectangle", "none")

  for (shape in test_shapes) {
    if (shape %in% shapes) {
      result <- safe_plot(soplot(mat, node_shape = shape, layout = "circle"))
      expect_true(result$success,
                  info = paste("Shape", shape, "failed:", result$error))
    }
  }
})

# ============================================
# Built-in Themes Registry Tests
# ============================================

test_that("register_builtin_themes registers classic theme", {
  themes <- list_themes()
  expect_true("classic" %in% themes)
})

test_that("register_builtin_themes registers colorblind theme", {
  themes <- list_themes()
  expect_true("colorblind" %in% themes)
})

test_that("register_builtin_themes registers gray/grey theme", {
  themes <- list_themes()
  expect_true("gray" %in% themes || "grey" %in% themes)
})

test_that("register_builtin_themes registers dark theme", {
  themes <- list_themes()
  expect_true("dark" %in% themes)
})

test_that("register_builtin_themes registers minimal theme", {
  themes <- list_themes()
  expect_true("minimal" %in% themes)
})

test_that("register_builtin_themes registers viridis theme", {
  themes <- list_themes()
  expect_true("viridis" %in% themes)
})

test_that("register_builtin_themes registers nature theme", {
  themes <- list_themes()
  expect_true("nature" %in% themes)
})

test_that("all built-in themes work in soplot", {
  mat <- create_test_matrix(4)
  themes <- list_themes()

  for (theme in themes) {
    result <- safe_plot(soplot(mat, theme = theme, layout = "circle"))
    expect_true(result$success,
                info = paste("Theme", theme, "failed:", result$error))
  }
})

test_that("classic theme produces valid plot", {
  mat <- create_test_matrix(4)

  result <- safe_plot(soplot(mat, theme = "classic", layout = "circle"))
  expect_true(result$success, info = result$error)
})

test_that("dark theme produces valid plot", {
  mat <- create_test_matrix(4)

  result <- safe_plot(soplot(mat, theme = "dark", layout = "circle"))
  expect_true(result$success, info = result$error)
})

test_that("theme functions return valid theme objects", {
  classic <- theme_cograph_classic()
  expect_true(is.list(classic))

  colorblind <- theme_cograph_colorblind()
  expect_true(is.list(colorblind))

  dark <- theme_cograph_dark()
  expect_true(is.list(dark))

  minimal <- theme_cograph_minimal()
  expect_true(is.list(minimal))
})

# ============================================
# Integration Tests
# ============================================

test_that("shapes and themes work together", {
  mat <- create_test_matrix(4)

  result <- safe_plot(
    soplot(mat,
           node_shape = "star",
           theme = "dark",
           layout = "circle")
  )
  expect_true(result$success, info = result$error)
})

test_that("different shapes per node work", {
  mat <- create_test_matrix(4)

  result <- safe_plot(
    soplot(mat,
           node_shape = c("circle", "square", "triangle", "diamond"),
           layout = "circle")
  )
  expect_true(result$success, info = result$error)
})
