# Extended tests for splot internals
# Covers: R/splot-nodes.R, R/splot-labels.R, R/splot-arrows.R, R/splot-geometry.R

# ============================================
# Node Rendering Tests (splot-nodes.R)
# ============================================

test_that("splot renders nodes with different shapes", {
  mat <- create_test_matrix(4)

  shapes <- c("circle", "square", "triangle", "diamond", "pentagon", "hexagon")
  for (shape in shapes) {
    result <- safe_plot(splot(mat, node_shape = shape))
    expect_true(result$success, info = paste("Shape failed:", shape, "-", result$error))
  }
})

test_that("splot renders nodes with different sizes", {
  mat <- create_test_matrix(4)

  # Single size
  result <- safe_plot(splot(mat, node_size = 5))
  expect_true(result$success, info = result$error)

  # Vector of sizes
  result <- safe_plot(splot(mat, node_size = c(3, 5, 7, 9)))
  expect_true(result$success, info = result$error)
})

test_that("splot renders nodes with different fills", {
  mat <- create_test_matrix(4)

  # Single color
  result <- safe_plot(splot(mat, node_fill = "steelblue"))
  expect_true(result$success, info = result$error)

  # Vector of colors
  result <- safe_plot(splot(mat, node_fill = c("red", "green", "blue", "yellow")))
  expect_true(result$success, info = result$error)
})

test_that("splot renders nodes with different border colors", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, node_border_color = "navy", node_border_width = 2))
  expect_true(result$success, info = result$error)
})

test_that("splot renders nodes with alpha transparency", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, node_alpha = 0.5))
  expect_true(result$success, info = result$error)

  # Vector of alphas
  result <- safe_plot(splot(mat, node_alpha = c(0.3, 0.5, 0.7, 1.0)))
  expect_true(result$success, info = result$error)
})

test_that("splot renders pie chart nodes", {
  mat <- create_test_matrix(3)

  result <- safe_plot(splot(mat, node_shape = "pie",
                            pie_values = list(c(1, 2, 3), c(2, 2, 2), c(3, 2, 1))))
  expect_true(result$success, info = result$error)
})

test_that("splot renders donut nodes", {
  mat <- create_test_matrix(3)

  result <- safe_plot(splot(mat, node_shape = "donut",
                            pie_values = list(0.3, 0.6, 0.9)))
  expect_true(result$success, info = result$error)
})

# ============================================
# Label Rendering Tests (splot-labels.R)
# ============================================

test_that("splot renders labels in center", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = TRUE, label_position = "center"))
  expect_true(result$success, info = result$error)
})

test_that("splot renders labels above nodes", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = TRUE, label_position = "above"))
  expect_true(result$success, info = result$error)
})

test_that("splot renders labels below nodes", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = TRUE, label_position = "below"))
  expect_true(result$success, info = result$error)
})

test_that("splot renders labels left of nodes", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = TRUE, label_position = "left"))
  expect_true(result$success, info = result$error)
})

test_that("splot renders labels right of nodes", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = TRUE, label_position = "right"))
  expect_true(result$success, info = result$error)
})

test_that("splot renders custom labels", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, labels = c("Alpha", "Beta", "Gamma", "Delta")))
  expect_true(result$success, info = result$error)
})

test_that("splot renders labels with custom size", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = TRUE, label_size = 1.5))
  expect_true(result$success, info = result$error)
})

test_that("splot renders labels with custom color", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = TRUE, label_color = "red"))
  expect_true(result$success, info = result$error)
})

test_that("splot hides labels when show_labels is FALSE", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, show_labels = FALSE))
  expect_true(result$success, info = result$error)
})

# ============================================
# Arrow Rendering Tests (splot-arrows.R)
# ============================================

test_that("splot renders arrows on directed networks", {
  mat <- create_test_matrix(4, symmetric = FALSE)

  result <- safe_plot(splot(mat, show_arrows = TRUE))
  expect_true(result$success, info = result$error)
})

test_that("splot respects arrow_size parameter", {
  mat <- create_test_matrix(4, symmetric = FALSE)

  result <- safe_plot(splot(mat, show_arrows = TRUE, arrow_size = 0.02))
  expect_true(result$success, info = result$error)

  result <- safe_plot(splot(mat, show_arrows = TRUE, arrow_size = 0.05))
  expect_true(result$success, info = result$error)
})

test_that("splot respects bidirectional parameter", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, bidirectional = TRUE))
  expect_true(result$success, info = result$error)
})

test_that("splot hides arrows when show_arrows is FALSE", {
  mat <- create_test_matrix(4, symmetric = FALSE)

  result <- safe_plot(splot(mat, show_arrows = FALSE))
  expect_true(result$success, info = result$error)
})

# ============================================
# Edge Rendering Tests
# ============================================

test_that("splot renders edges with different widths", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, edge_width = 3))
  expect_true(result$success, info = result$error)
})

test_that("splot renders edges with different colors", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, edge_color = "red"))
  expect_true(result$success, info = result$error)
})

test_that("splot renders edges with different styles", {
  mat <- create_test_matrix(4)

  for (style in c("solid", "dashed", "dotted")) {
    result <- safe_plot(splot(mat, edge_style = style))
    expect_true(result$success, info = paste("Style failed:", style, "-", result$error))
  }
})

test_that("splot renders curved edges", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, curvature = 0.5))
  expect_true(result$success, info = result$error)
})

test_that("splot renders edge labels", {
  mat <- create_test_matrix(4, weighted = TRUE)

  result <- safe_plot(splot(mat, edge_labels = TRUE))
  expect_true(result$success, info = result$error)
})

test_that("splot renders positive/negative edge colors", {
  mat <- create_test_matrix(4, weighted = TRUE, symmetric = FALSE)

  result <- safe_plot(splot(mat,
                            edge_positive_color = "green",
                            edge_negative_color = "red"))
  expect_true(result$success, info = result$error)
})

# ============================================
# Self-loop Tests
# ============================================

test_that("splot renders self-loops", {
  mat <- diag(1, 4)
  mat[1, 2] <- mat[2, 1] <- 1

  result <- safe_plot(splot(mat))
  expect_true(result$success, info = result$error)
})

test_that("splot respects loop_rotation parameter", {
  mat <- diag(1, 4)
  mat[1, 2] <- mat[2, 1] <- 1

  result <- safe_plot(splot(mat, loop_rotation = pi/4))
  expect_true(result$success, info = result$error)
})

# ============================================
# Geometry Tests
# ============================================

test_that("splot handles nodes at boundary positions", {
  mat <- create_test_matrix(4)
  layout <- matrix(c(0, 0, 1, 1, 0, 1, 0, 1), ncol = 2)

  result <- safe_plot(splot(mat, layout = layout))
  expect_true(result$success, info = result$error)
})

test_that("splot handles overlapping nodes", {
  mat <- create_test_matrix(4)
  layout <- matrix(c(0.5, 0.5, 0.51, 0.51, 0.5, 0.51, 0.5, 0.51), ncol = 2)

  result <- safe_plot(splot(mat, layout = layout))
  expect_true(result$success, info = result$error)
})

# ============================================
# Title and Margins Tests
# ============================================

test_that("splot renders title", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, title = "Test Network"))
  expect_true(result$success, info = result$error)
})

test_that("splot respects margins", {
  mat <- create_test_matrix(4)

  result <- safe_plot(splot(mat, margins = c(0.1, 0.1, 0.2, 0.1)))
  expect_true(result$success, info = result$error)
})

# ============================================
# Large Network Tests
# ============================================

test_that("splot handles medium-sized networks", {
  mat <- create_test_matrix(20, density = 0.3)

  result <- safe_plot(splot(mat))
  expect_true(result$success, info = result$error)
})

test_that("splot handles sparse networks", {
  mat <- create_test_matrix(10, density = 0.1)

  result <- safe_plot(splot(mat))
  expect_true(result$success, info = result$error)
})

test_that("splot handles dense networks", {
  mat <- create_test_matrix(8, density = 0.9)

  result <- safe_plot(splot(mat))
  expect_true(result$success, info = result$error)
})

# ============================================
# Edge Scale Mode Tests
# ============================================

test_that("splot edge_scale_mode linear works", {
  mat <- create_test_matrix(4, weighted = TRUE)

  result <- safe_plot(splot(mat, edge_scale_mode = "linear"))
  expect_true(result$success, info = result$error)
})

test_that("splot edge_scale_mode log works", {
  mat <- create_test_matrix(4, weighted = TRUE)

  result <- safe_plot(splot(mat, edge_scale_mode = "log"))
  expect_true(result$success, info = result$error)
})

test_that("splot edge_scale_mode sqrt works", {
  mat <- create_test_matrix(4, weighted = TRUE)

  result <- safe_plot(splot(mat, edge_scale_mode = "sqrt"))
  expect_true(result$success, info = result$error)
})

test_that("splot edge_scale_mode rank works", {
  mat <- create_test_matrix(4, weighted = TRUE)

  result <- safe_plot(splot(mat, edge_scale_mode = "rank"))
  expect_true(result$success, info = result$error)
})
